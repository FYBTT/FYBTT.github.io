I"xÎ<p>iotop è¿è¡Œåœ¨ç”¨æˆ·æ€ï¼Œä½†ioçš„ç®¡ç†æ˜¯å†…æ ¸æ€å®Œæˆçš„ã€‚iotopçš„æ•°æ®ç»Ÿè®¡æœ¬è´¨å°±æ˜¯ä¸æ–­ä»å†…æ ¸è·å–æ•°æ®ã€‚</p>
<h1 id="èƒŒæ™¯çŸ¥è¯†">èƒŒæ™¯çŸ¥è¯†</h1>
<h2 id="linux-pidtgidå…³ç³»">Linux pid,tgidå…³ç³»</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                        <span class="n">USER</span> <span class="n">VIEW</span>
 <span class="o">&lt;--</span> <span class="n">PID</span> <span class="mi">43</span> <span class="o">--&gt;</span> <span class="o">&lt;-----------------</span> <span class="n">PID</span> <span class="mi">42</span> <span class="o">-----------------&gt;</span>
                     <span class="o">+---------+</span>
                     <span class="o">|</span> <span class="n">process</span> <span class="o">|</span>
                    <span class="n">_</span><span class="o">|</span> <span class="n">pid</span><span class="o">=</span><span class="mi">42</span>  <span class="o">|</span><span class="n">_</span>
                  <span class="n">_</span><span class="o">/</span> <span class="o">|</span> <span class="n">tgid</span><span class="o">=</span><span class="mi">42</span> <span class="o">|</span> \<span class="n">_</span> <span class="p">(</span><span class="n">new</span> <span class="n">thread</span><span class="p">)</span> <span class="n">_</span>
       <span class="n">_</span> <span class="p">(</span><span class="n">fork</span><span class="p">)</span> <span class="n">_</span><span class="o">/</span>   <span class="o">+---------+</span>                  \
      <span class="o">/</span>                                        <span class="o">+---------+</span>
<span class="o">+---------+</span>                                    <span class="o">|</span> <span class="n">process</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">process</span> <span class="o">|</span>                                    <span class="o">|</span> <span class="n">pid</span><span class="o">=</span><span class="mi">44</span>  <span class="o">|</span>
<span class="o">|</span> <span class="n">pid</span><span class="o">=</span><span class="mi">43</span>  <span class="o">|</span>                                    <span class="o">|</span> <span class="n">tgid</span><span class="o">=</span><span class="mi">42</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">tgid</span><span class="o">=</span><span class="mi">43</span> <span class="o">|</span>                                    <span class="o">+---------+</span>
<span class="o">+---------+</span>
 <span class="o">&lt;--</span> <span class="n">PID</span> <span class="mi">43</span> <span class="o">--&gt;</span> <span class="o">&lt;---------</span> <span class="n">PID</span> <span class="mi">42</span> <span class="o">--------&gt;</span> <span class="o">&lt;---</span> <span class="n">PID</span> <span class="mi">44</span> <span class="o">---&gt;</span>
                        <span class="n">KERNEL</span> <span class="n">VIEW</span>
</code></pre></div></div>
<p>ä¸Šå›¾å¾ˆå¥½åœ°æè¿°äº†ç”¨æˆ·è§†è§’(user view)å’Œå†…æ ¸è§†è§’(kernel view)çœ‹åˆ°çº¿ç¨‹çš„å·®åˆ«ï¼š</p>

<ol>
  <li>ä»ç”¨æˆ·è§†è§’å‡ºå‘ï¼Œåœ¨pid 42ä¸­äº§ç”Ÿçš„tid 44çº¿ç¨‹ï¼Œå±äºtgid(çº¿ç¨‹ç»„leaderçš„è¿›ç¨‹ID) 42ã€‚ç”šè‡³ç”¨pså’Œtopçš„é»˜è®¤å‚æ•°ï¼Œä½ éƒ½æ— æ³•çœ‹åˆ°tid 44çº¿ç¨‹ã€‚</li>
  <li>ä»å†…æ ¸è§†è§’å‡ºå‘ï¼Œtid 42å’Œtid 44æ˜¯ç‹¬ç«‹çš„è°ƒåº¦å•å…ƒï¼Œå¯ä»¥æŠŠä»–ä»¬è§†ä¸ºâ€pid 42â€å’Œâ€pid 44â€ã€‚(å†…æ ¸åªæœ‰taskçš„æ¦‚å¿µ)</li>
</ol>

<p>ä¸¾ä¸ªæ —å­ï¼Œæœ¬åœ°pid(1832)ä¸‹çš„è¿›ç¨‹æ ‘ï¼Œç”±<code class="highlighter-rouge">pstree</code>ç”Ÿæˆã€‚{}è¡¨ç¤ºçº¿ç¨‹ã€‚<code class="highlighter-rouge">/proc/pid/task</code>ä»…åŒ…å«çº¿ç¨‹ã€‚</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dockerd</span><span class="p">(</span><span class="mi">1832</span><span class="p">)</span><span class="err">â”€â”¬â”€</span><span class="n">docker</span><span class="o">-</span><span class="n">proxy</span><span class="p">(</span><span class="mi">26423</span><span class="p">)</span><span class="err">â”€â”¬â”€</span><span class="p">{</span><span class="n">docker</span><span class="o">-</span><span class="n">proxy</span><span class="p">}(</span><span class="mi">26424</span><span class="p">)</span>
 <span class="n">tgid</span> <span class="o">=</span> <span class="mi">1832</span>  <span class="err">â”‚</span>     <span class="n">tgid</span> <span class="o">=</span> <span class="mi">26423</span>    <span class="err">â”œâ”€</span><span class="p">{</span><span class="n">docker</span><span class="o">-</span><span class="n">proxy</span><span class="p">}(</span><span class="mi">26425</span><span class="p">)</span>
              <span class="err">â”‚</span>                     <span class="err">â”œâ”€</span><span class="p">{</span><span class="n">docker</span><span class="o">-</span><span class="n">proxy</span><span class="p">}(</span><span class="mi">26426</span><span class="p">)</span>
              <span class="err">â”‚</span>                     <span class="err">â”œâ”€</span><span class="p">{</span><span class="n">docker</span><span class="o">-</span><span class="n">proxy</span><span class="p">}(</span><span class="mi">26427</span><span class="p">)</span>
              <span class="err">â”‚</span>                     <span class="err">â”œâ”€</span><span class="p">{</span><span class="n">docker</span><span class="o">-</span><span class="n">proxy</span><span class="p">}(</span><span class="mi">26428</span><span class="p">)</span>
              <span class="err">â”‚</span>   <span class="n">tgid</span> <span class="o">=</span> <span class="mi">1832</span>       <span class="err">â”œâ”€</span><span class="p">{</span><span class="n">docker</span><span class="o">-</span><span class="n">proxy</span><span class="p">}(</span><span class="mi">26429</span><span class="p">)</span>
              <span class="err">â”‚</span>   <span class="n">task</span> <span class="n">Dir</span>          <span class="err">â”œâ”€</span><span class="p">{</span><span class="n">docker</span><span class="o">-</span><span class="n">proxy</span><span class="p">}(</span><span class="mi">26430</span><span class="p">)</span>
           <span class="o">|</span><span class="err">â€”â€”â”‚â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</span><span class="o">|</span>   <span class="err">â””â”€</span><span class="p">{</span><span class="n">docker</span><span class="o">-</span><span class="n">proxy</span><span class="p">}(</span><span class="mi">9413</span><span class="p">)</span>
           <span class="err">â”‚</span>  <span class="err">â”œâ”€</span><span class="p">{</span><span class="n">dockerd</span><span class="p">}(</span><span class="mi">1894</span><span class="p">)</span> <span class="o">|</span>
           <span class="err">â”‚</span>  <span class="err">â”œâ”€</span><span class="p">{</span><span class="n">dockerd</span><span class="p">}(</span><span class="mi">1896</span><span class="p">)</span> <span class="o">|</span>
           <span class="err">â”‚</span>  <span class="err">â”œâ”€</span><span class="p">{</span><span class="n">dockerd</span><span class="p">}(</span><span class="mi">1897</span><span class="p">)</span> <span class="o">|</span>
           <span class="err">â”‚</span>  <span class="err">â”œâ”€</span><span class="p">{</span><span class="n">dockerd</span><span class="p">}(</span><span class="mi">1898</span><span class="p">)</span> <span class="o">|</span>
           <span class="err">â”‚</span>  <span class="err">â”œâ”€</span><span class="p">{</span><span class="n">dockerd</span><span class="p">}(</span><span class="mi">1900</span><span class="p">)</span> <span class="o">|</span>
           <span class="err">â”‚</span>  <span class="err">â”œâ”€</span><span class="p">{</span><span class="n">dockerd</span><span class="p">}(</span><span class="mi">1907</span><span class="p">)</span> <span class="o">|</span>
           <span class="err">â”‚</span>  <span class="err">â”œâ”€</span><span class="p">{</span><span class="n">dockerd</span><span class="p">}(</span><span class="mi">1909</span><span class="p">)</span> <span class="o">|</span>
           <span class="err">â”‚</span>  <span class="err">â”œâ”€</span><span class="p">{</span><span class="n">dockerd</span><span class="p">}(</span><span class="mi">1942</span><span class="p">)</span> <span class="o">|</span>
           <span class="err">â”‚</span>  <span class="err">â”œâ”€</span><span class="p">{</span><span class="n">dockerd</span><span class="p">}(</span><span class="mi">1947</span><span class="p">)</span> <span class="o">|</span>
           <span class="err">â”‚</span>  <span class="err">â”œâ”€</span><span class="p">{</span><span class="n">dockerd</span><span class="p">}(</span><span class="mi">1948</span><span class="p">)</span> <span class="o">|</span>
           <span class="err">â”‚</span>  <span class="err">â”œâ”€</span><span class="p">{</span><span class="n">dockerd</span><span class="p">}(</span><span class="mi">1950</span><span class="p">)</span> <span class="o">|</span>
           <span class="err">â”‚</span>  <span class="err">â”œâ”€</span><span class="p">{</span><span class="n">dockerd</span><span class="p">}(</span><span class="mi">2142</span><span class="p">)</span> <span class="o">|</span>
           <span class="err">â”‚</span>  <span class="err">â””â”€</span><span class="p">{</span><span class="n">dockerd</span><span class="p">}(</span><span class="mi">26431</span><span class="p">)</span><span class="o">|</span>
           <span class="o">|</span><span class="err">â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</span><span class="o">|</span>
</code></pre></div></div>
<h2 id="è¿›ç¨‹ä¼˜å…ˆçº§">è¿›ç¨‹ä¼˜å…ˆçº§</h2>

<p><strong>PRI</strong>:è¿›ç¨‹ä¼˜å…ˆæƒï¼Œä»£è¡¨è¿™ä¸ªè¿›ç¨‹å¯è¢«æ‰§è¡Œçš„ä¼˜å…ˆçº§ï¼Œå…¶å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§å°±è¶Šé«˜ï¼Œè¶Šæ—©è¢«æ‰§è¡Œ;</p>

<p><strong>NI</strong>:è¿›ç¨‹Niceå€¼ï¼Œä»£è¡¨è¿™ä¸ªè¿›ç¨‹çš„ä¼˜å…ˆå€¼;</p>
<blockquote>
  <p>PRIæ˜¯æ¯”è¾ƒå¥½ç†è§£çš„ï¼Œå³è¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œæˆ–è€…é€šä¿—ç‚¹è¯´å°±æ˜¯ç¨‹åºè¢«CPUæ‰§è¡Œçš„å…ˆåé¡ºåºï¼Œæ­¤å€¼è¶Šå°è¿›ç¨‹çš„ä¼˜å…ˆçº§åˆ«è¶Šé«˜ã€‚é‚£NIå‘¢ï¼Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¦è¯´çš„niceå€¼äº†ï¼Œå…¶è¡¨ç¤ºè¿›ç¨‹å¯è¢«æ‰§è¡Œçš„ä¼˜å…ˆçº§çš„ä¿®æ­£æ•°å€¼ã€‚PRIå€¼è¶Šå°è¶Šå¿«è¢«æ‰§è¡Œï¼Œé‚£ä¹ˆåŠ å…¥niceå€¼åï¼Œå°†ä¼šä½¿å¾—PRIå˜ä¸ºï¼šPRI(new)=PRI(old)+niceã€‚ç”±æ­¤çœ‹å‡ºï¼Œè§„åˆ™æ˜¯NICEè¶Šå°ï¼Œå…¶è¿›ç¨‹ä¼˜å…ˆçº§ä¼šå˜é«˜ï¼Œåˆ™å…¶è¶Šå¿«è¢«æ‰§è¡Œã€‚è¿›ç¨‹niceå€¼å’Œè¿›ç¨‹ä¼˜å…ˆçº§ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œä½†æ˜¯è¿›ç¨‹niceå€¼ä¼šå½±å“åˆ°è¿›ç¨‹çš„ä¼˜å…ˆçº§å˜åŒ–ã€‚</p>
</blockquote>

<h1 id="æºç ç»“æ„è§£æ">æºç ç»“æ„è§£æ</h1>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>â”œâ”€â”€ iotop
â”‚Â Â  â”œâ”€â”€ data.py
â”‚Â Â  â”œâ”€â”€ genetlink.py
â”‚Â Â  â”œâ”€â”€ __init__.py<span class="o">(</span>æ— å†…å®¹ï¼Œä¸æ¶‰åŠ<span class="o">)</span>
â”‚Â Â  â”œâ”€â”€ ioprio.py
â”‚Â Â  â”œâ”€â”€ netlink.py
â”‚Â Â  â”œâ”€â”€ ui.py<span class="o">(</span>ç”¨æˆ·äº¤äº’éƒ¨åˆ†ï¼Œä¸æ¶‰åŠ<span class="o">)</span>
â”‚Â Â  â”œâ”€â”€ version.py<span class="o">(</span>æ— å†…å®¹ï¼Œä¸æ¶‰åŠ<span class="o">)</span>
â”‚Â Â  â””â”€â”€ vmstat.py
</code></pre></div></div>
<p><img src="/img/perf/iotop.png" alt="iotop" /></p>
<ol>
  <li>æ•°æ®ç”±taskstatsè·å–,ç´¯åŠ æ‰€æœ‰taskå¾—åˆ°ã€‚</li>
  <li>æ•°æ®ç”±vmstatä¸­è¯»å–ã€‚</li>
  <li>ç”±ioprioæ¨¡å—æä¾›</li>
  <li>ç”±dataæ¨¡å—ï¼Œæ ¹æ®pidè·å–å¯¹åº”çš„uid</li>
  <li>é€šè¿‡taskstatsè·å–çš„taskè¯»å†™ä¿¡æ¯ï¼Œå…¶å®è¯»å†™ä¿¡æ¯é€šè¿‡procfsä¹Ÿèƒ½è·å–ï¼Œä½†iodelayçš„è·å–è¿‡ç¨‹å·²ç»é™„å¸¦äº†è¯»å†™ä¿¡æ¯ï¼ˆä¸ªäººå‘ï¼‰</li>
  <li>é€šè¿‡taskstatsè·å–çš„iodelayï¼Œå¦‚æœiodelayä¸ºä¸€ç›´0ï¼Œè¿™é‡Œæ˜¾ç¤ºä¸ºunaviable</li>
  <li>é€šè¿‡cmdlineä¿¡æ¯æˆ–è€…statusä¸­çš„nameä¿¡æ¯æä¾›</li>
</ol>

<h2 id="vmstatæ¨¡å—">vmstatæ¨¡å—</h2>
<p>æ¨¡å—ä¸­ä»…åŒ…å«ä¸€ä¸ªç±»VmStatï¼Œè¿™ä¸ªç±»ä¸»è¦è´Ÿè´£è·Ÿ/proc/vmstatæ–‡ä»¶çš„äº¤äº’ã€‚</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">æä¾›</span><span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">vmstat</span><span class="err">çš„ä¿¡æ¯</span>
<span class="k">def</span> <span class="nf">read</span><span class="p">():</span>
    <span class="n">pgpgin</span> <span class="err">ä»¥</span><span class="n">KB</span><span class="err">è¡¨ç¤ºç³»ç»Ÿä»ç£ç›˜è¯»å…¥åˆ°å†…å­˜çš„æ•°æ®é‡å¤§å°</span>
    <span class="n">pgpgout</span> <span class="err">ä»¥</span><span class="n">KB</span><span class="err">è¡¨ç¤ºç³»ç»Ÿä»å†…å­˜å†™å‡ºåˆ°ç£ç›˜çš„æ•°æ®é‡å¤§å°</span>
    <span class="err">è¿”å›</span><span class="p">(</span><span class="n">pgpgin</span><span class="p">,</span> <span class="n">pgpgout</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">delta</span><span class="p">():</span>
    <span class="err">è¿”å›æ–°è·å–çš„</span><span class="p">(</span><span class="n">pgpgin</span><span class="p">,</span> <span class="n">pgpgout</span><span class="p">)</span> <span class="o">-</span> <span class="err">ä¹‹å‰ä¿å­˜çš„</span><span class="p">(</span><span class="n">pgpgin</span><span class="p">,</span> <span class="n">pgpgout</span><span class="p">)</span><span class="err">å·®å€¼</span>
</code></pre></div></div>

<h2 id="netlinkæ¨¡å—">netlinkæ¨¡å—</h2>

<p>netlinkæ˜¯ä¸€ç§ä»‹äºåœ¨å†…æ ¸ç©ºé—´ä¸ç”¨æˆ·ç©ºé—´ä¹‹é—´è¿›è¡Œæ•°æ®ä¼ è¾“çš„ç‰¹æ®Šçš„é€šä¿¡æ–¹å¼ã€‚å®ƒé€šè¿‡ä¸ºä¸ºç”¨æˆ·ç¨‹åºæä¾›äº†ä¸€ç»„æ ‡å‡†çš„socket æ¥å£ï¼Œå¹¶ä¸ºå†…æ ¸æ¨¡å—æä¾›ä¸€ç»„ç‰¹æ®Šçš„APIçš„æ–¹å¼ï¼Œå®ç°äº†å…¨åŒå·¥çš„é€šè®¯è¿æ¥ã€‚ç±»ä¼¼äºTCP/IPä½¿ç”¨AF_INETåœ°å€æ—ï¼Œnetlink socketä½¿ç”¨å¦ä¸€ç§åœ°å€æ—AF_NETLINKã€‚</p>

<p>æ¨¡å—ä¸­ä¸»è¦åŒ…å«ç±»<strong>Connection</strong>å’Œç±»<strong>Message</strong>ï¼Œä¸ºç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„æ•°æ®ä¼ è¾“äº¤äº’æä¾›åŸºç¡€æœåŠ¡ã€‚
ä¸Šå±‚é€šè¿‡Messageå‘é€æ•°æ®ï¼ŒåŸºç¡€æœåŠ¡è¿”å›ä¸€ä¸ªMessageç»™ä¸Šå±‚æ¥å£ã€‚</p>

<p><strong>netlink 16å­—èŠ‚çš„åè®®å¤´</strong></p>

<p><img src="/img/perf/netlink.png" alt="netlinkåè®®å¤´" /></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Message</span><span class="p">:</span>
    <span class="err">ç”¨</span><span class="n">msg_type</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">contents</span> <span class="err">åˆ›å»º</span><span class="n">Message</span>
    <span class="bp">self</span><span class="o">.</span><span class="nb">type</span> <span class="o">=</span> <span class="n">msg_type</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">payload</span> <span class="o">=</span> <span class="err">å°†</span><span class="n">contents</span><span class="err">å¤„ç†æˆå­—ç¬¦ä¸²çš„å½¢å¼</span>
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">seq</span><span class="p">()</span>
        <span class="err">æ„é€ </span><span class="n">netlink</span><span class="err">åè®®å¤´</span><span class="o">-</span><span class="n">header</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="n">contents</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">():</span><span class="c1">#å®šä¹‰Messageçš„æ‰“å°æ ¼å¼
</span>        <span class="k">return</span> <span class="s">'&lt;netlink.Message type=</span><span class="si">%</span><span class="s">d, pid=</span><span class="si">%</span><span class="s">d, seq=</span><span class="si">%</span><span class="s">d, flags=0x</span><span class="si">%</span><span class="s">x "</span><span class="si">%</span><span class="s">s"&gt;'</span>
</code></pre></div></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Connection</span><span class="p">:</span>
     <span class="err">ä½¿ç”¨åè®®æ—</span><span class="n">AF_NETLINK</span><span class="err">å»ºç«‹</span><span class="n">socket</span><span class="err">è¿æ¥</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="err">è§£æ„</span><span class="n">socket</span>
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
        <span class="err">é€šè¿‡</span><span class="n">socket</span><span class="err">å‘é€</span><span class="n">msg</span>
    <span class="k">def</span> <span class="nf">receive</span><span class="p">():</span>
        <span class="n">msglen</span><span class="p">,</span> <span class="n">msg_type</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">pid</span> <span class="o">=</span> <span class="err">è§£æè¿”å›æ•°æ®çš„å‰</span><span class="mi">16</span><span class="err">ä¸ªå­—èŠ‚</span>
        <span class="err">åˆå§‹åŒ–ä¸€ä¸ª</span><span class="n">Message</span><span class="p">(</span><span class="n">msg_type</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="mi">16</span><span class="err">ä¸ªå­—èŠ‚ä»¥åçš„æ•°æ®</span><span class="p">)</span> <span class="o">+</span> <span class="n">pid</span>
        <span class="k">return</span> <span class="n">Message</span>
    <span class="k">def</span> <span class="nf">seq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="c1">#ç›¸å½“äºå‘é€ä¿¡æ¯çš„ç¼–å·
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_seq</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seq</span>
</code></pre></div></div>
<h2 id="genetlinkæ¨¡å—">genetlinkæ¨¡å—</h2>
<p>æ¨¡å—ä¸­ä¸»è¦åŒ…å«ç±»<strong>GeNlMessage</strong>å’Œç±»<strong>Controller</strong>ï¼Œç”¨äºè·å–ä¸€ç»„ç‰¹å®šçš„æ•°æ®ï¼ˆåè®®æ—ä¿¡æ¯ï¼‰ã€‚</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">GeNlMessage</span><span class="p">(</span><span class="n">Message</span><span class="p">)</span><span class="c1">#ç»§æ‰¿äºMessage
</span>    <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">family</span>
    <span class="err">åˆ©ç”¨ä¼ å…¥çš„</span><span class="n">family</span><span class="p">,</span> <span class="n">flags</span><span class="err">ï¼Œ</span> <span class="n">contents</span><span class="err">åˆå§‹åŒ–ä¸€ä¸ª</span><span class="n">Message</span><span class="err">ï¼Œ</span>
    <span class="err">æ³¨æ„</span><span class="n">seq</span><span class="err">ä¿¡æ¯ä¼šåœ¨</span><span class="n">Message</span><span class="err">å¾—åˆ°æ›´æ–°</span>
    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">recv</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span><span class="c1">#é™æ€å‡½æ•°ï¼Œç‹¬ç«‹äºå¯¹è±¡å­˜åœ¨
</span>        <span class="n">msg</span> <span class="o">=</span> <span class="n">connecttion</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>
        <span class="k">return</span> <span class="err">åˆå§‹åŒ–çš„ä¸€ä¸ª</span><span class="n">GelMessage</span>
</code></pre></div></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Controller</span>
    <span class="err">æ¥å—ä¸€ä¸ªå¤–éƒ¨ä¼ å…¥çš„</span><span class="n">connection</span>
    <span class="k">def</span> <span class="nf">get_family_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">family</span><span class="p">):</span>
        <span class="err">æ„å»ºè·å–</span><span class="n">family_id</span><span class="err">çš„å‘½ä»¤</span><span class="p">:</span><span class="n">CTRL_CMD_GETFAMILY</span>
        <span class="err">åˆå§‹åŒ–ä¸€ä¸ª</span><span class="n">GeNlMessage</span>
        <span class="err">è°ƒç”¨</span><span class="n">GeNlMessage</span><span class="err">çˆ¶ç±»</span><span class="n">Message</span><span class="err">çš„</span><span class="n">send</span><span class="err">å‡½æ•°</span>
        <span class="n">re</span> <span class="o">=</span> <span class="n">GeNlMessage</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">CTRL_ATTR_FAMILY_ID</span><span class="p">]</span>   
</code></pre></div></div>

<h2 id="ioprioæ¨¡å—">ioprioæ¨¡å—</h2>
<p>è¿™éƒ¨åˆ†æ¯”è¾ƒç²—æš´ï¼Œä¸»è¦ä½¿ç”¨å°±æ˜¯æ ¹æ®ç”¨æˆ·è¾“å…¥çš„pidæ˜¾ç¤ºè¿™ä¸ªtaskçš„ä»»åŠ¡ä¼˜å…ˆçº§ï¼Œä¹Ÿå¯ç”¨æ¥è®¾ç½®ä»»åŠ¡ä¼˜å…ˆçº§ï¼ˆä¸å¸¸ç”¨ï¼‰ã€‚
æ¨¡å—ä¸­éœ€è¦ç»™å‡ºä¸åŒç³»ç»Ÿä¸­ç³»ç»Ÿè°ƒç”¨å·è¡¨çš„ç¼–å·ã€‚</p>

<p><strong>æ³¨æ„</strong>ï¼Œè¿™é‡Œé¢æ˜¯æ²¡æœ‰aarch64çš„ï¼ŒCentOSæä¾›çš„iotop rpmæºç åŒ…ä¸­æœ‰ç›¸å…³patch</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IOPRIO_GET_ARCH_SYSCALL</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s">'alpha'</span><span class="p">,</span>       <span class="s">'*'</span><span class="p">,</span>  <span class="mi">443</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'arm*'</span><span class="p">,</span>        <span class="s">'*'</span><span class="p">,</span>  <span class="mi">315</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'i*86'</span><span class="p">,</span>        <span class="s">'*'</span><span class="p">,</span>  <span class="mi">290</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'ia64*'</span><span class="p">,</span>       <span class="s">'*'</span><span class="p">,</span> <span class="mi">1275</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'parisc*'</span><span class="p">,</span>     <span class="s">'*'</span><span class="p">,</span>  <span class="mi">268</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'powerpc*'</span><span class="p">,</span>    <span class="s">'*'</span><span class="p">,</span>  <span class="mi">274</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'s390*'</span><span class="p">,</span>       <span class="s">'*'</span><span class="p">,</span>  <span class="mi">283</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'sparc*'</span><span class="p">,</span>      <span class="s">'*'</span><span class="p">,</span>  <span class="mi">218</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'sh*'</span><span class="p">,</span>         <span class="s">'*'</span><span class="p">,</span>  <span class="mi">289</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'x86_64*'</span><span class="p">,</span> <span class="s">'32bit'</span><span class="p">,</span>  <span class="mi">290</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'x86_64*'</span><span class="p">,</span> <span class="s">'64bit'</span><span class="p">,</span>  <span class="mi">252</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">IOPRIO_SET_ARCH_SYSCALL</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s">'alpha'</span><span class="p">,</span>       <span class="s">'*'</span><span class="p">,</span>  <span class="mi">442</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'arm*'</span><span class="p">,</span>        <span class="s">'*'</span><span class="p">,</span>  <span class="mi">314</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'i*86'</span><span class="p">,</span>        <span class="s">'*'</span><span class="p">,</span>  <span class="mi">289</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'ia64*'</span><span class="p">,</span>       <span class="s">'*'</span><span class="p">,</span> <span class="mi">1274</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'parisc*'</span><span class="p">,</span>     <span class="s">'*'</span><span class="p">,</span>  <span class="mi">267</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'powerpc*'</span><span class="p">,</span>    <span class="s">'*'</span><span class="p">,</span>  <span class="mi">273</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'s390*'</span><span class="p">,</span>       <span class="s">'*'</span><span class="p">,</span>  <span class="mi">282</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'sparc*'</span><span class="p">,</span>      <span class="s">'*'</span><span class="p">,</span>  <span class="mi">196</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'sh*'</span><span class="p">,</span>         <span class="s">'*'</span><span class="p">,</span>  <span class="mi">288</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'x86_64*'</span><span class="p">,</span>  <span class="s">'32bit'</span><span class="p">,</span> <span class="mi">289</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'x86_64*'</span><span class="p">,</span>  <span class="s">'64bit'</span><span class="p">,</span> <span class="mi">251</span><span class="p">),</span>
<span class="p">]</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ioprio</span>
<span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">ioprio</span><span class="p">):</span>
</code></pre></div></div>
<h2 id="dataæ¨¡å—">dataæ¨¡å—</h2>
<p>å‘UIæä¾›æ•°æ®ï¼Œè¿™é‡Œå¯¹Statséœ€è¦ä¸€ä¸‹è¯´æ˜ï¼š</p>

<blockquote>
  <p>swapin_delay_total: ä»å‘ç”Ÿpage faultå¼€å§‹ï¼Œåˆ°å®Œæˆswapinç»“æŸçš„è€—æ—¶</p>
</blockquote>

<blockquote>
  <p>blkio_delay_total: ä»æäº¤åŒæ­¥IOå¼€å§‹ï¼Œåˆ°åŒæ­¥IOè¿”å›ç»“æŸçš„è€—æ—¶ï¼›blkio_delay_totalç›¸å…³ä»£ç å¦‚ä¸‹ã€‚</p>
</blockquote>

<pre><code class="language-C">path: linux/kernel/delayacct.c
int __delayacct_add_tsk(struct taskstats *d, struct task_struct *tsk)
{
    ...
    tmp = d-&gt;blkio_delay_total + tsk-&gt;delays-&gt;blkio_delay;
    d-&gt;blkio_delay_total = (tmp &lt; d-&gt;blkio_delay_total) ? 0 : tmp;
    ... 
    return 0;
}

path: linux/kernel/core.c(blkio_delayçš„æ›´æ–°)
/*
* This task is about to go to sleep on IO. Increment rq-&gt;nr_iowait so
* that process accounting knows that this is a task in IO wait state.
*/
long __sched io_schedule_timeout(long timeout)
{
    int old_iowait = current-&gt;in_iowait;
    struct rq *rq;
    long ret;
 
    current-&gt;in_iowait = 1;
    blk_schedule_flush_plug(current);
 
    delayacct_blkio_start();
    rq = raw_rq();
    atomic_inc(&amp;rq-&gt;nr_iowait);
    ret = schedule_timeout(timeout);
    current-&gt;in_iowait = old_iowait;
    atomic_dec(&amp;rq-&gt;nr_iowait);
    delayacct_blkio_end();
 
    return ret;
}
EXPORT_SYMBOL(io_schedule_timeout);
</code></pre>
<blockquote>
  <p>cancelled_write_bytes: è¿™é‡Œçš„æ•°æ®ç”±truncateå¼•å‘ï¼ŒæˆªçŸ­äº†cacheä¸­çš„æ–‡ä»¶ï¼Œäº‹å®ä¸Šå°±å‡å°‘äº†åŸæœ¬è¦å‘ç”Ÿçš„å†™I/O</p>
</blockquote>

<blockquote>
  <p>read_bytes: è¿›ç¨‹è¯»å–çš„ç‰©ç†I/Oå­—èŠ‚æ•°ï¼ŒåŒ…æ‹¬mmap pageinï¼Œåœ¨submit_bio()ä¸­ç»Ÿè®¡çš„</p>
</blockquote>

<blockquote>
  <p>write_bytes: è¿›ç¨‹å†™å‡ºçš„ç‰©ç†I/Oå­—èŠ‚æ•°ï¼ŒåŒ…æ‹¬mmap pageoutï¼Œåœ¨submit_bio()ä¸­ç»Ÿè®¡çš„</p>
</blockquote>

<p>ç°åœ¨æ¥çœ‹ä¸‹Statsä»£ç ã€‚</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Stats</span><span class="p">:</span>
    <span class="c1">#Statsä¸»è¦è´Ÿè´£ä»å†…æ ¸ä¸­ä¸æ–­è·å–ä»¥ä¸‹çš„5ä¸ªå€¼
</span>    <span class="n">members_offsets</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s">'blkio_delay_total'</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'swapin_delay_total'</span><span class="p">,</span> <span class="mi">56</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'read_bytes'</span><span class="p">,</span> <span class="mi">248</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'write_bytes'</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'cancelled_write_bytes'</span><span class="p">,</span> <span class="mi">264</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="c1">#ç±»å˜é‡ï¼Œç‹¬ç«‹äºå®ä¾‹å¤–
</span>    <span class="n">has_blkio_delay_total</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_stats_buffer</span><span class="p">):</span>
        <span class="c1">#æ•°æ®è¢«å†™å…¥åˆ°å®ä¾‹å†…ç½®çš„å­—å…¸ä¸­
</span>        <span class="n">sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">Stats</span><span class="o">.</span><span class="n">members_offsets</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">task_stats_buffer</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span>
            <span class="n">sd</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">'Q'</span><span class="p">,</span> <span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># This is a heuristic to detect 
</span>        <span class="c1"># if CONFIG_TASK_DELAY_ACCT is enabled in
</span>        <span class="c1"># the kernel.
</span>        <span class="c1">#æ³¨æ„è¿™é‡Œçš„åªè¦æœ‰ä¸€æ¬¡æ”¶åˆ°çš„blkio_delay_totalé0
</span>        <span class="c1">#has_blkio_delay_totalå°±ä¼šè¢«ç½®ä¸ºtrue
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">Stats</span><span class="o">.</span><span class="n">has_blkio_delay_total</span><span class="p">:</span>
            <span class="n">Stats</span><span class="o">.</span><span class="n">has_blkio_delay_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blkio_delay_total</span> <span class="o">!=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">accumulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_stats</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="s">"""Update destination from operator(self, other_stats)"""</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">destination</span><span class="o">.</span><span class="n">__dict__</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span>
        <span class="n">od</span> <span class="o">=</span> <span class="n">other_stats</span><span class="o">.</span><span class="n">__dict__</span>
        <span class="k">for</span> <span class="n">member</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">Stats</span><span class="o">.</span><span class="n">members_offsets</span><span class="p">:</span>
            <span class="n">dd</span><span class="p">[</span><span class="n">member</span><span class="p">]</span> <span class="o">=</span> <span class="n">sd</span><span class="p">[</span><span class="n">member</span><span class="p">]</span> <span class="o">+</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">od</span><span class="p">[</span><span class="n">member</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_stats</span><span class="p">,</span> <span class="n">destination</span><span class="p">):</span>
        <span class="s">"""Update destination with self - other_stats"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">other_stats</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">is_all_zero</span><span class="p">():</span>
        <span class="c1">#åˆ¤æ–­å†…ç½®å­—å…¸ä¸­çš„5ä¸ªå˜é‡å…¨éƒ¨ä¸º0
</span>
    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">build_all_zero</span><span class="p">():</span>
        <span class="c1">#åˆ›å»ºä¸€ä¸ª5ä¸ªå˜é‡å…¨0çš„Statå®ä¾‹ï¼Œå¹¶è¿”å›
</span></code></pre></div></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TaskStatsNetlink</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="n">NETLINK_GENERIC</span><span class="p">)</span>
        <span class="n">controller</span> <span class="o">=</span> <span class="n">Controller</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">family_id</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">get_family_id</span><span class="p">(</span><span class="s">'TASKSTATS'</span><span class="p">)</span>
    
    <span class="c1">#ç»„è£…å‘½ä»¤è·å–å†…æ ¸ä¸­taskstatsçš„æ•°æ®
</span>    <span class="k">def</span> <span class="nf">build_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tid</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">GeNlMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">family_id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="n">TASKSTATS_CMD_GET</span><span class="p">,</span>
                           <span class="n">attrs</span><span class="o">=</span><span class="p">[</span><span class="n">U32Attr</span><span class="p">(</span><span class="n">TASKSTATS_CMD_ATTR_PID</span><span class="p">,</span> <span class="n">tid</span><span class="p">)],</span>
                           <span class="n">flags</span><span class="o">=</span><span class="n">NLM_F_REQUEST</span><span class="p">)</span> 
    
    <span class="k">def</span> <span class="nf">get_single_task_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thread</span><span class="p">):</span>
        <span class="c1">#æäº¤ç»„è£…çš„å‘½ä»¤
</span>        <span class="c1">#æ ¹æ®è·å–æŸä¸ªtidå¯¹åº”çš„taskstatsæ•°æ®ç»„è£…ä¸€ä¸ªStatsï¼Œå¹¶è¿”å›
</span></code></pre></div></div>
<hr />

<p>ThreadInfoç±»æä¾›çº¿ç¨‹ä¼˜å…ˆçº§å’Œçº¿ç¨‹çº§Statsçš„delta</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ThreadInfo</span><span class="p">:</span>
    <span class="s">"""Stats for a single thread"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">taskstats_connection</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tid</span> <span class="o">=</span> <span class="n">tid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mark</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_total</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_delta</span> <span class="o">=</span> <span class="n">Stats</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">Stats</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_stats_request</span> <span class="o">=</span> <span class="n">taskstats_connection</span><span class="o">.</span><span class="n">build_request</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_ioprio</span><span class="p">():</span>
        <span class="c1">#è¿”å›å½“å‰çº¿ç¨‹tidçš„ä»»åŠ¡ä¼˜å…ˆçº§
</span>    
    <span class="k">def</span> <span class="nf">set_ioprio</span><span class="p">():</span>
        <span class="c1">#è®¾ç½®å½“æ°å¿åŸtidçš„ä»»åŠ¡ä¼˜å…ˆçº§
</span>    
    <span class="c1">#self.stats_deltaä¿å­˜æ–°è·å–çš„stats - è€çš„stats(self.stats_total)
</span>    <span class="k">def</span> <span class="nf">update_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stats</span><span class="p">):</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_total</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats_total</span> <span class="o">=</span> <span class="n">stats</span>
        <span class="n">stats</span><span class="o">.</span><span class="n">delta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_total</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_delta</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_total</span> <span class="o">=</span> <span class="n">stats</span>
</code></pre></div></div>
<hr />

<p>æ—¢ç„¶è¿™ä¸ªç±»è¢«å‘½åä¸ºProessInfoï¼Œå¾ˆå®¹æ˜“çŒœåˆ°é‡Œé¢ä¼šåŒ…å«ç±»threadsæˆå‘˜ã€‚</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ProcessInfo</span><span class="p">:</span>
    <span class="c1">#Stats for a single process (a single line in the output): 
</span>    <span class="c1">#if options.processes is set, it is a collection of threads, 
</span>    <span class="c1">#otherwise a singlethread.
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># {tid: ThreadInfo}
</span>        <span class="c1">#è¿™é‡Œå¯ä»¥çœ‹åˆ°Processå’ŒThreadéƒ½æœ‰stats_delta
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">stats_delta</span> <span class="o">=</span> <span class="n">Stats</span><span class="o">.</span><span class="n">build_all_zero</span><span class="p">()</span>
        <span class="c1">#è¿™é‡Œçš„accumå®é™…ä¸Šå°±æ˜¯deltaçš„ä¸æ–­ç´¯è®¡
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">stats_accum</span> <span class="o">=</span> <span class="n">Stats</span><span class="o">.</span><span class="n">build_all_zero</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_accum_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">is_monitored</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="c1">#é€šè¿‡optionçš„å‚æ•°åˆ¤æ–­æ˜¯åè¦æ˜¾ç¤ºå½“å‰è¿›ç¨‹
</span>    
    <span class="k">def</span> <span class="nf">get_uid</span><span class="p">:</span>
        <span class="c1">#é€šè¿‡pidè·å–è¿™ä¸ªtaskçš„ç”¨æˆ·ID
</span>
    <span class="k">def</span> <span class="nf">get_user</span><span class="p">:</span>
        <span class="c1">#é€šè¿‡uidè·å–ç”¨æˆ·å
</span>    
    <span class="k">def</span> <span class="nf">get_cmdline</span><span class="p">:</span>
        <span class="c1">#è¿™ä¸ªå‡½æ•°å¾ˆæ˜æ˜¾ï¼Œæ˜¯ä¸ºäº†è·å–è¿›ç¨‹çš„cmdlineï¼Œ
</span>        <span class="c1">#æ³¨æ„å†…æ ¸çº¿ç¨‹æ˜¯æ‰¾ä¸åˆ°cmdlineçš„ï¼Œè½¬è€Œä¼šè·å–statusä¸­çš„name
</span>
    <span class="k">def</span> <span class="nf">did_some_io</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accumulated</span><span class="p">):</span>
        <span class="c1">#å¦‚æœdeltaä¸º0æˆ–è€…accumä¸º0 return false
</span>    
    <span class="k">def</span> <span class="nf">get_ioprio</span><span class="p">:</span>
        <span class="c1">#è·å–æ‰€æœ‰å­©å­threadsçš„ioprioï¼Œå–set
</span>        <span class="c1">#å¦‚æœå‘ç°setçš„sizeå¤§äº1ï¼Œè¡¨æ˜ioprioå¼‚å¸¸
</span>
    <span class="k">def</span> <span class="nf">set_ioprio</span><span class="p">:</span>
        <span class="c1">#åŒthreadçš„set_ioprio
</span>
    <span class="k">def</span> <span class="nf">get_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">taskstats_connection</span><span class="p">):</span>
        <span class="c1">#é€šè¿‡tidè¿”å›threadInfoï¼Œ
</span>        <span class="c1">#å¦‚æœä¸å­˜åœ¨è¿™ä¸ªthreadï¼Œé€šè¿‡tidå’Œtaskstats_conn
</span>        <span class="c1">#åˆ›å»ºä¸€ä¸ªthreadInfo
</span>
    <span class="k">def</span> <span class="nf">update_stats</span><span class="p">:</span>
        <span class="c1">#ç´¯è®¡æ‰€æœ‰çš„threadsçš„stats_deltaåˆ°ä¸´æ—¶tmp_statsä¸­ï¼Œ
</span>        <span class="n">tmp</span><span class="o">.</span><span class="n">blkio_delay_total</span> <span class="o">/=</span> <span class="n">nr_threads</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">swapin_delay_total</span> <span class="o">/=</span> <span class="n">nr_threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_delta</span> <span class="o">=</span> <span class="n">tmp</span>
        <span class="c1">#ç´¯è®¡stats_deltaåˆ°stats_accumä¸­
</span></code></pre></div></div>
<hr />
<p>è¿™ä¸ªç±»å¾ˆæ˜æ˜¾æ˜¯ä¸ºäº†ç»´æŠ¤processåˆ—è¡¨</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ProcessList</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taskstats_connection</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="c1"># {pid: ProcessInfo}
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">processes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskstats_connection</span> <span class="o">=</span> <span class="n">taskstats_connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vmstat</span> <span class="o">=</span> <span class="n">vmstat</span><span class="o">.</span><span class="n">VmStat</span><span class="p">()</span>

        <span class="c1"># A first time as we are interested in the delta
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">update_process_counts</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
        <span class="c1">#æ ¹æ®pidä»processesä¸­è·å–processInfo
</span>        <span class="c1">#å¦‚æœä¸å­˜åœ¨è¿™ä¸ªprocessInfoï¼Œé€šè¿‡pidåˆ›å»ºä¸€ä¸ª
</span>        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">is_monitored</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">process</span>

    <span class="k">def</span> <span class="nf">list_tgids</span><span class="p">:</span>
        <span class="c1">#å¦‚æœoptionä¸­å·²ç»æŒ‡å®šäº†pidsï¼Œç›´æ¥è¿”å›pids
</span>        <span class="c1">#å¦‚æœoprionä¸­æŒ‡å®šprocessï¼Œè¿”å›/procä¸‹çš„æ‰€æœ‰pid
</span>        <span class="c1">#å¦‚æœoptionä¸­æœªæŒ‡å®šprocessï¼Œè¿”å›æ‰€æœ‰çš„taskä¸­çš„pid
</span>
    <span class="k">def</span> <span class="nf">list_tids</span><span class="p">(</span><span class="n">tgids</span><span class="p">):</span>
        <span class="c1">#å¦‚æœoptionä¸­å·²ç»æŒ‡å®šäº†processï¼Œç›´æ¥è¿”å›pids
</span>        <span class="c1">#tids = è·å–æŒ‡å®štgidsä¸‹çš„taskåˆ—è¡¨
</span>        <span class="c1">#å¦‚æœoptionä¸­æŒ‡å®šäº†pidsï¼Œåˆå¹¶tidså’Œpids
</span>
    <span class="k">def</span> <span class="nf">update_process_counts</span><span class="p">:</span>
        <span class="c1">#ä¿å­˜è¯¥å‡½æ•°è°ƒç”¨çš„æ—¶é—´
</span>        <span class="n">new_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">new_timestamp</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">new_timestamp</span>
        <span class="n">foreach</span> <span class="err">è¿›ç¨‹åˆ—è¡¨ï¼š</span>
            <span class="n">foreach</span> <span class="err">çº¿ç¨‹åˆ—è¡¨ï¼š</span>
                <span class="err">è·å–</span><span class="n">thread</span><span class="err">å¯¹åº”çš„</span><span class="n">stats</span>
                    <span class="n">thread</span><span class="o">.</span><span class="n">update_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
                    <span class="n">delta</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">stats_delta</span>
                    <span class="n">total_read</span> <span class="o">+=</span> <span class="n">delta</span><span class="o">.</span><span class="n">read_bytes</span>
                    <span class="n">total_write</span> <span class="o">+=</span> <span class="n">delta</span><span class="o">.</span><span class="n">write_bytes</span>
                    <span class="n">thread</span><span class="o">.</span><span class="n">mark</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">total_read</span><span class="p">,</span> <span class="n">total_write</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">vmstat</span><span class="o">.</span><span class="n">delta</span><span class="p">()</span>
   
   <span class="k">def</span> <span class="nf">refresh_processes</span><span class="p">:</span>
        <span class="n">foreach</span> <span class="err">è¿›ç¨‹åˆ—è¡¨ï¼š</span>
            <span class="n">foreach</span> <span class="err">çº¿ç¨‹åˆ—è¡¨ï¼š</span>
                <span class="n">thread</span><span class="o">.</span><span class="n">mark</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">total_read_and_write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_process_counts</span><span class="p">()</span>
</code></pre></div></div>

:ET